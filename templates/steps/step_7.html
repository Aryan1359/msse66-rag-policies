
{% extends "base.html" %}
{% block page_title %}Step 7: Ask / RAG Generation{% endblock %}
{% block content %}
<div class="container mt-4">
  <form method="POST" action="{{ url_for('step7_bp.api_keys') }}" class="card p-3 mb-4">
    <h5 class="mb-3">API Key Management</h5>
    <div class="row mb-2">
      <div class="col-md-4">
        <label for="openrouter_key" class="form-label">OpenRouter API Key</label>
        <div class="input-group">
          <input type="text" name="openrouter_key" id="openrouter_key" class="form-control" value="{{ api_keys.OPENROUTER_API_KEY }}" placeholder="Enter OpenRouter API Key">
          <button type="submit" name="use_env_openrouter" value="1" class="btn btn-outline-secondary">Use Repo Secret</button>
        </div>
      </div>
      <div class="col-md-4">
        <label for="groq_key" class="form-label">Groq API Key</label>
        <input type="text" name="groq_key" id="groq_key" class="form-control" value="{{ api_keys.GROQ_API_KEY }}" placeholder="Enter Groq API Key">
      </div>
      <div class="col-md-4">
        <label for="openai_key" class="form-label">OpenAI API Key</label>
        <input type="text" name="openai_key" id="openai_key" class="form-control" value="{{ api_keys.OPENAI_API_KEY }}" placeholder="Enter OpenAI API Key">
      </div>
    </div>
    <div class="row mb-2">
      <div class="col-md-12">
        <button type="submit" class="btn btn-success">Save API Keys</button>
        <button type="submit" name="delete" value="1" class="btn btn-danger ms-2">Delete All Keys</button>
      </div>
    </div>
    <div class="row mb-2">
      <div class="col-md-12">
        <small class="text-muted">Keys are stored securely for future use. Only providers with keys set will be available for selection below.</small>
      </div>
    </div>
  </form>
  <form method="POST" action="{{ url_for('step7_bp.ask_route') }}" class="card p-3 mb-4">
    <div class="row mb-2">
      <div class="col-md-3">
        <label for="method" class="form-label">Chunking Method</label>
        <select name="method" id="method" class="form-select">
          <option value="headings" {% if method == 'headings' %}selected{% endif %}>By Heading</option>
          <option value="token" {% if method == 'token' %}selected{% endif %}>By Token</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="db_key" class="form-label">Document Index</label>
        <select name="db_key" id="db_key" class="form-select">
          {% for db in dbs %}
            <option value="{{ db.key }}" {% if db.key == selected_db %}selected{% endif %}>{{ db.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label for="provider" class="form-label">AI Provider</label>
        <select name="provider" id="provider" class="form-select">
          {% for p in available_providers %}
            <option value="{{ p }}">{{ p|capitalize }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label for="topk" class="form-label">Top-K Chunks</label>
        <input type="number" name="topk" id="topk" class="form-control" value="{{ topk }}" min="1" max="20">
      </div>
      <div class="col-md-2">
        <label for="min_score" class="form-label">Min Score</label>
        <input type="text" name="min_score" id="min_score" class="form-control" value="{{ min_score }}">
      </div>
    </div>
    <div class="row mb-2">
      <div class="col-md-3">
        <label for="answer_len" class="form-label">Answer Length</label>
        <select name="answer_len" id="answer_len" class="form-select">
          <option value="short" {% if answer_len == 'short' %}selected{% endif %}>Short</option>
          <option value="med" {% if answer_len == 'med' %}selected{% endif %}>Medium</option>
          <option value="long" {% if answer_len == 'long' %}selected{% endif %}>Long</option>
        </select>
      </div>
      <div class="col-md-9">
        <label for="question" class="form-label">Your Question</label>
        <input type="text" name="question" id="question" class="form-control" value="{{ question }}" placeholder="e.g. What is the PTO policy?" required>
      </div>
    </div>
    <button type="submit" class="btn btn-primary mt-2">Ask</button>
  </form>

  {% if error %}
    <div class="alert alert-danger">Error: {{ error }}</div>
  {% endif %}

  {# Only render answer and context once #}
  {% if error %}
    <div class="alert alert-danger">Error: {{ error }}</div>
  {% endif %}

  {% if answer %}
    <div class="card mb-3">
      <div class="card-header"><b>Answer</b></div>
      <div class="card-body">
        <p>{{ answer }}</p>
        {% if citations %}
          <p><b>Citations:</b> 
            {% for c in citations %}
              <span class="badge bg-secondary">{{ c }}</span>
            {% endfor %}
          </p>
        {% endif %}
      </div>
    </div>
  {% endif %}

  {% if context_chunks %}
    <div class="card mb-3">
      <div class="card-header"><b>Retrieved Chunks</b></div>
      <div class="card-body">
        <ul>
        {% for chunk in context_chunks %}
          <li><b>{{ chunk.doc_id }}#{{ chunk.chunk_id }}</b>: {{ chunk.text|truncate(180) }}</li>
        {% endfor %}
        </ul>
      </div>
    </div>
  {% endif %}

  <div class="alert alert-info mt-4">
    <h4 class="mb-2">Step 7 Overview</h4>
    <p>This step lets you ask questions about your indexed policy documents using Retrieval-Augmented Generation (RAG). Your query is answered by an AI model, strictly grounded in the retrieved document chunks, with citations for every fact.</p>
    <hr>
    <h5 class="mb-1">Document Index</h5>
    <ul>
      <li><b>Definition:</b> A Document Index is a collection of embedded document chunks created in previous steps. Each index represents a different chunking or embedding strategy (e.g., by headings or by tokens).</li>
      <li><b>Purpose:</b> It determines which set of document chunks the system will search to answer your question. Different indexes may yield different retrieval and answer quality.</li>
      <li><b>How to Use:</b> Select your preferred chunking method (e.g., "By Heading" or "By Token"). The system will use the corresponding index for retrieval and answer generation.</li>
      <li><b>Tip:</b> If you only see chunking method options, each method maps to a single index. Pick the method that best matches your question or desired context.</li>
    </ul>
    <hr>
    <h5 class="mb-1">Top-K Chunks</h5>
    <ul>
      <li><b>Definition:</b> Top-K controls how many of the most relevant document chunks are retrieved and used to answer your question.</li>
      <li><b>Purpose:</b> A lower Top-K (e.g., 3) gives concise, focused answers. A higher Top-K (e.g., 10 or 20) provides more context, which can help with complex questions but may introduce irrelevant information.</li>
      <li><b>How to Use:</b> Adjust Top-K to balance answer depth and focus. Default is usually 5. Increase for broader context, decrease for more precise answers.</li>
    </ul>
    <hr>
    <h5 class="mb-1">Min Score</h5>
    <ul>
      <li><b>Definition:</b> Min Score sets the minimum similarity required for a chunk to be considered relevant and included in the answer context. Scores typically range from -1 (least similar) to 1 (most similar).</li>
      <li><b>Purpose:</b> It helps filter out less relevant or noisy chunks, improving answer quality. Higher Min Score means stricter filtering; lower Min Score means more context but possibly more noise.</li>
      <li><b>How to Use:</b> Default is usually 0.0. Adjust up (e.g., 0.2, 0.5) for stricter, more focused answers. Adjust down (e.g., -0.2) for broader context or if you get "No evidence found" errors.</li>
    </ul>
    <hr>
    <h5 class="mb-1">How to use Step 7</h5>
    <ul>
      <li>Select a chunking method (Document Index) and set retrieval parameters: <b>Top-K</b> and <b>Min Score</b>.</li>
      <li>Choose an AI Provider (OpenRouter, Groq, or OpenAI; API key required).</li>
      <li>Type your question and submit.</li>
      <li>The answer will be generated, strictly citing the source chunks. Youâ€™ll see the answer, citations, and the retrieved context.</li>
    </ul>
    <b>Strict Grounding:</b> The answer is only allowed to use information from the retrieved chunks. All facts must be cited (e.g., <code>doc1#3</code>).<br>
    <b>Provider Selection:</b> Only providers with API keys set are available.<br>
    <b>Logging:</b> All queries and answers are logged for review and reproducibility.
  </div>
</div>
{% endblock %}
