
{% extends "base.html" %}
{% block page_title %}Step 8{% endblock %}
{% block content %}
  <h2>Step 8: Evaluation & Metrics</h2>
  <form method="post" class="mb-3">
    <label for="window">Time Window:</label>
    <select name="window" id="window" class="form-select w-auto d-inline-block">
      <option value="all" {% if window=='all' %}selected{% endif %}>All</option>
      <option value="24h" {% if window=='24h' %}selected{% endif %}>Last 24h</option>
      <option value="7d" {% if window=='7d' %}selected{% endif %}>Last 7 days</option>
      <option value="30d" {% if window=='30d' %}selected{% endif %}>Last 30 days</option>
    </select>
    <button type="submit" class="btn btn-primary ms-2">Update</button>
  </form>
  {% if no_data %}
    <div class="alert alert-warning">No evaluation data available for the selected window.</div>
  {% else %}
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Metrics</div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item">Total Questions: <b>{{ metrics.n_questions }}</b></li>
            <li class="list-group-item">Grounded Rate: <b>{{ metrics.grounded_rate }}%</b></li>
            <li class="list-group-item">Citation Correctness: <b>{{ metrics.citation_correctness }}%</b></li>
            <li class="list-group-item">Median Generation Latency: <b>{{ metrics.median_gen or 'N/A' }} ms</b></li>
            <li class="list-group-item">Median Retrieval Latency: <b>{{ metrics.median_ret or 'N/A' }} ms</b></li>
            <li class="list-group-item">Median End-to-End Latency: <b>{{ metrics.end_to_end or 'N/A' }} ms</b></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Recent Questions</div>
        <div class="card-body p-0">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>Time</th>
                <th>Query</th>
                <th>Status</th>
                <th>Citations</th>
                <th>Latency (ms)</th>
              </tr>
            </thead>
            <tbody>
              {% for r in recent %}
              <tr>
                <td>{{ r.time }}</td>
                <td>{{ r.query|truncate(40) }}</td>
                <td>{{ r.status }}</td>
                <td>{{ r.citations_count }}</td>
                <td>{{ r.latency_ms or 'N/A' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  <div class="card mt-4">
    <div class="card-header">Step 8 Overview</div>
    <div class="card-body">
      <p>This dashboard provides evaluation and metrics for RAG question answering. Metrics include:</p>
      <ul>
        <li><b>Grounded Rate</b>: % of answers with at least one citation.</li>
        <li><b>Citation Correctness</b>: % of answers where all citations match retrieved chunks.</li>
        <li><b>Median Latency</b>: Generation, retrieval, and end-to-end times (ms).</li>
      </ul>
      <p>Use the time window selector to filter metrics and recent questions. Data is parsed from logs generated in Step 6 and Step 7.</p>
    </div>
  </div>
{% endblock %}
